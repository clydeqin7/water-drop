# 前端全链路性能优化实战

极客时间《前端全链路性能优化实战》学习笔记

# 一、静态资源优化

## 1. 图片优化

### 1.1 不同格式图片适用场景

#### JPEG(Joint Photographic Experts Group)

+ 联合图像专家小组是一种针对彩色照片而广泛使用的有损压缩图形格式。
  + 介绍：栅格图形。常用文件拓展名为`.jpg`，也有`.jpeg`，`.jpe`。JPEG在互联网上常被应用于存储和传输照片。
  + 不适合：线条图形和文字、图标图形，因为它的压缩算法不太适合这类型的图形；并且不支持透明度。
  + 适合：颜色丰富的照片，色彩图大焦点图、通栏 banner 图；结构不规则的图形。

#### PNG(Portable Network Graphics)

+ 便携式网络图形是一种无损压缩的[位图]([https://baike.baidu.com/item/%E4%BD%8D%E5%9B%BE](https://baike.baidu.com/item/位图))图形格式，支持索引、灰度、RGB 三种颜色方案以及 Alpha 通道等特性。
  + 介绍：栅格图形。PNG 最初是作为替代 GIF 来设计的，能够显示 256 色，文件比 JPEG 或者 GIF 大，但是 PNG 非常好的保留了图像质量。支持 Alpha 通道等半透明和透明特性。最高支持 24 位彩色图像 （PNG-24）和 8 位灰度图像（PNG-8）。
  + 不适合：由于是无损存储，彩色图像体积太大，所以不太适合。
  + 非常适合：纯色、透明、线条绘图，图标；边缘清晰、有大块相同颜色区域；颜色数较少但非常需要半透明。

#### GIF(Graphics Interchange Format)

+ 图像互换格式是一种位图图形文件格式，以 8 位色（即 256 种颜色）重现真彩色的图像，采用 LZW 压缩算法进行编码。
  - 介绍：栅格图形。支持 256 色；仅支持完全透明和完全不透明；如果需要比较通用的动画，GIF 是唯一的选择。
  - 不适合：每个像素只有 8 比特，不适合存储彩色图片。
  - 非常适合：动画，图标。

#### Webp

+ Webp 是一种现代图像格式，可为图像提供无损压缩和有损压缩，这使得它非常灵活。由 Google 在购买 On2 Technologies 后发展出来，以 BSD 授权条款发布。
  - 介绍：优秀算法能同时保证一定程度上的图像质量和比较小的体积；可以插入多帧，实现动画效果；可以设置透明度；采用 8 位压缩算法。无损的 Webp 比 PNG 小 26%，有损的 Webp 比 JPEG 小 25-34%，比 GIF 有更好的动画。
  - 不适合：最多处理 256 色，不适合于彩色图片。
  - 非常适合：适用于图形和半透明图像。

### 1.2 怎么让图片加载更快

#### 用工具进行图片压缩

##### 压缩 png

+ node-pngquant-native
+ 跨平台，压缩比高，压缩 png24 非常好。

##### 压缩 jpg

+ jpegtran
+ 跨平台，有 Linux、Mac、Windows 解决方案

##### 压缩 gif

+ Gifsicle：通过改变每帧比例，减小 gif 文件大小，同时可以使用透明来达到更小的文件大小，目前公认的解决方案。

#### 图片尺寸随网络环境变化

+ 不同网络环境(Wifi/4G/3G)下，加载不同尺寸和像素的图片，通过在图片 URL 后 缀加不同参数改变。
+ http://img13.360buyimg.com/n1/s100x100_jfs/t2443/71/2538811251/470889/c2ec38b3/570f3438N81a4b62c.jpg
+ http://img13.360buyimg.com/n1/s400x400_jfs/t2443/71/2538811251/470889/c2ec38b3/570f3438N81a4b62c.jpg

#### 响应式图片

+ JavaScript 绑定事件检测窗口大小

+ CSS 媒体查询

  ```CSS
  @media screen and (max-width: 640px) { 
  	my_image{ width: 640px; }
  }
  ```

+ img 标签属性

  ```CSS
  <img srcset="img-320w.jpg, img-640w.jpg 2x, img-960w.jpg 3x"
  		 src=“img-960w.jpg” alt=“img”> (x 描述符:表示图像的设备像素比)
  ```

#### 逐步加载图像

+ 使用统一占位符（比如使用公司logo）
+ 使用 LQIP
  + 低质量图像占位符（Low Quality Image Placehoders）
  + 源码：https://github.com/zouhir/lqip-loader
+ 使用 SQIP
  + 基于 SVG 的图像占位符（SVG Quality Image Placehoders）
  + 源码：https://github.com/axe312ger/sqip

#### 真的需要图片吗?

- Web Font 代替图片（如代替小图标、图片）
- 使用 Data URI 代替图片（base64 转码把图片放入本地，就不用发请求去读取图片）
- 采用 Image spriting(雪碧图)

### 1.3 服务器端进行图片自动优化的原理

#### 图片服务器自动优化解密

+ 名词解释

  - 图片服务器自动化优化是可以在图片URL链接上增加不同特殊参数，服务器自动化生成。

  - 不同格式、大小、质量的图片。

+ 处理方式

  - 图片裁剪:按长边、短边、填充、拉伸等缩放。
  - 图片格式转换:支持JPG，GIF，PNG，WebP等，支持不同的图片压缩率。
  - 图片处理:添加图片水印、高斯模糊、重心处理、裁剪边框等。
  - AI能力:鉴黄以及智能抠图、智能排版、智能配色、智能合成等AI功能。

#### 图片服务器自动优化解密

+ 默认jpg
  - https://m.360buyimg.com/test/s500x500_jfs/t2362/199/2707005502/100242/616257ce/56e66b21N7b8c2be8.jpg

- 大小 100*100 的 jpg
  - https://m.360buyimg.com/test/s100x100_jfs/t2362/199/2707005502/100242/616257ce/56e66b21N7b8c2be8.jpg
- webp 格式的图片
  - https://m.360buyimg.com/test/s500x500_jfs/t2362/199/2707005502/100242/616257ce/56e66b21N7b8c2be8.webp
- 质量压缩至10%
  - https://m.360buyimg.com/test/s500x500_jfs/t2362/199/2707005502/100242/616257ce/56e66b21N7b8c2be8.jpg!q10

#### 技术实现

1. 将图片压缩、图片裁剪、图片格式转换等本地工具部署至线上图片服务器集群上
2. 内部运营或外网用户上传本地图片至图片服务器后，服务器默认处理转换成多种图片格式，并推送至图片 CDN 服务器上
3. 图片服务器对外开放多个域名（如：images1.com、images2.com 等），同时对各个业务线开放不同的业务路径（如：images1.com/homepage 等）
4. 外网用户请求带特殊参数的图片 URL 时，图片服务器根据 URL 种不同的参数类型，从本地缓存中取得，或者实时对图片进行即时处理，并返回给客户端

## 2.HTML优化

## 3. CSS优化

# 二、页面渲染架构设计与性能优化

# 三、原生App优化

# 四、服务端和网络优化

# 五、研发开发流程优化

# 六、全链路质量监控体系建设